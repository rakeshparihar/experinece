<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>GlamAR Web SDK</title>
    <!-- Move script to end of body -->
  </head>
  <body>
    <!-- Container must be fully styled when SDK initializes -->
    <div
      id="glamar-container"
      style="
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        background: #fff;
        z-index: 1;
      "></div>

    <div class="toolbar" role="toolbar" aria-label="GlamAR Controls">
      <button id="btnOpen" type="button" disabled>Open Live</button>
      <button id="btnApplySku" type="button" disabled>Apply SKU</button>
      <button id="btnApplyCategory" type="button" disabled>
        Apply Category
      </button>
      <button id="btnClose" type="button" disabled>Close</button>
    </div>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      .toolbar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        gap: 8px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(6px);
        border-top: 1px solid #eee;
        z-index: 2147483647;
        pointer-events: auto;
      }
      .toolbar button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        font-weight: 600;
        cursor: pointer;
      }
      .toolbar button:not([disabled]):hover {
        background: #f7f7f7;
      }
    </style>

    <!-- Load SDK script at end of body -->
    <script src="https://cdn.glamar.io/sdk/wrapper"></script>

    <script>
      const ACCESS_KEY = "2d5e01fd-2130-4b70-9071-f11ed3faec1b";
      const DEFAULT_CATEGORY = "sunglasses";
      const SAMPLE_SKU = "AC000932039S26";

      let glamarSDK = null;

      async function waitForSDK(maxAttempts = 50) {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const check = () => {
            attempts++;
            if (window.GlamAR) {
              resolve(window.GlamAR);
            } else if (attempts >= maxAttempts) {
              reject(new Error("SDK failed to load"));
            } else {
              setTimeout(check, 100);
            }
          };
          check();
        });
      }

      async function initSDK() {
        try {
          const GlamAR = await waitForSDK();

          const options = {
            platform: "web",
            category: DEFAULT_CATEGORY,
            configuration: {
              global: {
                openLiveOnInit: false,
                disableClose: false,
                disableBack: false,
              },
              ui: {
                loader: { disable: false },
                watermark: { text: "", fontColor: "", logo: "" },
              },
              ar: { disable3DUI: false },
            },
          };

          glamarSDK = await GlamAR.init(
            "glamar-container",
            ACCESS_KEY,
            options
          );
          console.log("SDK initialized");

          GlamAR.addEventListener("loaded", () => {
            console.log("SDK loaded");
            enableButtons();
          });

          GlamAR.addEventListener("error", (error) => {
            console.error("SDK error:", error);
          });

          setupButtonHandlers(GlamAR);
        } catch (error) {
          console.error("SDK initialization failed:", error);
        }
      }

      function setupButtonHandlers(GlamAR) {
        const handlers = {
          btnOpen: () => GlamAR.open(),
          btnApplySku: () => GlamAR.applyBySku(SAMPLE_SKU),
          btnApplyCategory: () => GlamAR.applyByCategory(DEFAULT_CATEGORY),
          btnClose: () => GlamAR.close(),
        };

        Object.entries(handlers).forEach(([id, handler]) => {
          const button = document.getElementById(id);
          if (button) {
            button.addEventListener("click", async () => {
              try {
                button.disabled = true;
                await handler();
                console.log(`${id} action successful`);
              } catch (error) {
                console.error(`${id} action failed:`, error);
              } finally {
                button.disabled = false;
              }
            });
          }
        });
      }

      function enableButtons() {
        document.querySelectorAll(".toolbar button").forEach((button) => {
          button.disabled = false;
        });
      }

      // Only initialize when everything is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initSDK);
      } else {
        initSDK();
      }
    </script>
  </body>
</html>
