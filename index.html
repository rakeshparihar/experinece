<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>GlamAR Web SDK</title>
    <!-- Remove defer to ensure script loads before initialization -->
    <script src="https://cdn.glamarz0.de/sdk/wrapper?"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      #glamar-container {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        background: #fff;
        z-index: 1; /* SDK will create its own overlays; our toolbar will sit above them */
      }

      /* ðŸ”¥ Keep controls clickable above any SDK overlay */
      .toolbar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        gap: 8px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(6px);
        border-top: 1px solid #eee;
        z-index: 2147483647; /* max practical z-index */
        pointer-events: auto;
      }
      .toolbar button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        font-weight: 600;
        cursor: pointer;
      }
      .toolbar button:hover {
        background: #f7f7f7;
      }
    </style>
  </head>
  <body>
    <div id="glamar-container"></div>
    <div class="toolbar" role="toolbar" aria-label="GlamAR Controls">
      <button id="btnOpen" type="button">Open Live</button>
      <button id="btnApplySku" type="button">Apply SKU</button>
      <button id="btnApplyCategory" type="button">Apply Category</button>
      <button id="btnClose" type="button">Close</button>
    </div>

    <script>
      const ACCESS_KEY = "6bab2fda-1f0d-4205-8958-50c52045aa92";
      const DEFAULT_CATEGORY = "sunglasses";
      const SAMPLE_SKU = "e0a9ca75-607d-41ac-ba8d-854d96234a41";

      let glamarSDK = null;

      function waitForElement(elementId, timeout = 10000) {
        return new Promise((resolve, reject) => {
          const element = document.getElementById(elementId);
          if (element && element.style) {
            return resolve(element);
          }

          const timeoutId = setTimeout(() => {
            observer.disconnect();
            reject(
              new Error(`Element ${elementId} not found within ${timeout}ms`)
            );
          }, timeout);

          const observer = new MutationObserver(() => {
            const element = document.getElementById(elementId);
            if (element && element.style) {
              clearTimeout(timeoutId);
              observer.disconnect();
              resolve(element);
            }
          });

          observer.observe(document.body, {
            childList: true,
            subtree: true,
          });
        });
      }

      async function initSDK() {
        try {
          // Wait for container element to be ready
          const container = await waitForElement("glamar-container");

          // Ensure the container is fully rendered and accessible
          if (!container || !container.style) {
            throw new Error("Container element not properly initialized");
          }

          // Wait for SDK to be available
          if (!window.GlamAR) {
            await new Promise((resolve) => setTimeout(resolve, 1000));
          }

          // Double-check SDK availability
          if (!window.GlamAR) {
            throw new Error("GlamAR SDK not loaded");
          }

          const options = {
            platform: "web",
            category: DEFAULT_CATEGORY,
            ar: { disable3DUI: false }
          };

          // Initialize SDK
          glamarSDK = await window.GlamAR.init(
            "glamar-container",
            ACCESS_KEY,
            options
          );

          console.log("------SDK initialized");
          setupEventListeners();
        } catch (error) {
          console.error("SDK initialization failed:", error);
          // Retry initialization after a delay
          setTimeout(initSDK, 2000);
        }
      }

      function setupEventListeners() {
        if (!window.GlamAR) {
          console.error("GlamAR SDK not found");
          return;
        }

        window.GlamAR.addEventListener("loaded", () => {
          console.log("SDK loaded");
        });

        window.GlamAR.addEventListener("loading", () => {
          console.log("SDK ready");
          enableButtons();
        });

        window.GlamAR.addEventListener("error", (error) => {
          console.error("SDK error:", error);
        });

        setupButtonHandlers();
      }

      function setupButtonHandlers() {
        const buttons = {
          btnOpen: async () => await window.GlamAR.open(),
          btnApplySku: async () => await window.GlamAR.applyBySku(SAMPLE_SKU),
          btnApplyCategory: async () =>
            await window.GlamAR.applyByCategory(DEFAULT_CATEGORY),
          btnClose: async () => await window.GlamAR.close(),
        };

        Object.entries(buttons).forEach(([id, handler]) => {
          const button = document.getElementById(id);
          if (button) {
            button.addEventListener("click", async () => {
              try {
                await handler();
                console.log(`${id} action successful`);
              } catch (error) {
                console.error(`${id} action failed:`, error);
              }
            });
          }
        });
      }

      function enableButtons() {
        const buttons = document.querySelectorAll(".toolbar button");
        buttons.forEach((button) => button.removeAttribute("disabled"));
      }

      // Start initialization when document is ready
      window.addEventListener("load", () => {
        // Additional delay to ensure everything is fully rendered
        setTimeout(initSDK, 500);
      });
    </script>
  </body>
</html>
